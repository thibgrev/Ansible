- name: Deploiement de la VM nommee "{{ VMname }}"
  hosts: localhost
  gather_facts: no
  become: no
  vars:
    VMname: "tg-00000"
    template_of_VM: "tg-template-rhel_9"
    nbr_cpu: 2
    nbr_ram: 4096
  vars_files:
    - ../../Vault/secret.yml

  tasks:

    - name: Deploiement a partir du template VMWare
      community.vmware.vmware_guest:
        hostname: "{{ vault_vmware_hostname }}"
        username: "{{ vault_vmware_username }}"
        password: "{{ vault_vmware_password }}"
        datacenter: "DCA"
        validate_certs: no
        folder: "/DCA/vm/Environnement/tgrevellec"
        name: "{{ VMname }}"
        state: poweredon
        template: "{{ template_of_VM }}"
        hardware:
          memory_mb: "{{ nbr_ram }}"
          num_cpus: "{{ nbr_cpu }}"
          num_cpu_cores_per_socket: 2
          hotadd_cpu: true
          hotadd_memory: false
        wait_for_ip_address: true

    - name: set hostname
      ansible.builtin.hostname:
        name: "{{ VMname }}"
      delegate_to: "{{ VMname }}"
      ignore_errors:

    - name: Affichage du resultat
      ansible.builtin.debug:
        msg: "La VM nommee {{ VMname }} a ete deployee avec succes en utilisant le template nomme {{ template_of_VM }}."